<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>DALL-E Encoder Decoder Demo</title>
</head>
<body>
  <input type=file oninput="imgEl.src=window.URL.createObjectURL(this.files[0]); buttonsEl.style.display='';">
  <br><br>
  <img id=imgEl style="height:200px;">
  <br>
  <div id=buttonsEl style="display:none;">
    <button onclick="start()">start</button>
  </div>

  <script>
    async function start() {
      while(1) {
        let blob = await fetch(imgEl.src).then(r => r.blob());
        let formData = new FormData();
        formData.append("file", blob);

        // Encode:
        let encoded = await fetch("http://0.0.0.0:8080/encode", {
          method: 'POST',
          body: formData,
        }).then(r => r.json());

        // Perturb:
        let i = Math.floor(Math.random()*encoded[0].length);
        let j = Math.floor(Math.random()*encoded[0][0].length);
        encoded[0][i][j] = encoded[0][i][j] + (Math.random() < 0.5 ? -1 : 1);
        encoded[0][i][j] = encoded[0][i][j] < 0 ? 0 : (encoded[0][i][j] > 8191 ? 8191 : encoded[0][i][j]); // clamp

        // Decode:
        let decoded = await fetch("http://0.0.0.0:8080/decode", {
          method: 'POST',
          body: JSON.stringify(encoded),
        }).then(r => r.blob());

        imgEl.src = URL.createObjectURL(decoded);

        await new Promise(r => setTimeout(r, 10));
      }
    }
  </script>
</body>
</html>
